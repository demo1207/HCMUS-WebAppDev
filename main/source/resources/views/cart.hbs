<div class="container">
  <div class="row">
    <div class="cart-page col-12">
      <table class="table table-cart">
        <thead>
          <tr>
            <th width="20%"><i class="d-none fa fa-pink fa-1x5 fa-check-square"></i> Sản phẩm</th>
            <th width="25%" class="text-center">Mô tả</th>
            <th width="15%" class="text-center d-none d-md-table-cell">Đơn giá</th>
            <th width="15%" class="text-center d-none d-md-table-cell">Số lượng</th>
            <th width="15%" class="text-center d-none d-md-table-cell">Tổng</th>
            <th width="10%" class="text-center d-none d-md-table-cell">Thao tác</th>
          </tr>
        </thead>
        <tbody>
          {{#each accBuyer.cart}}
          <tr class="cart-item" data-psid="37901040">
            <td class="cart-img">
              <div class="d-flex align-items-center">
                <i class="d-none fa fa-pink fa-1x5 fa-check-square"></i>
                <a href="/mu-len-red-and-white-big-knitting-cuc-bong-xmas-do-p37901040.html"
                  title="{{this.id_product.name}}">
                  <img data-sizes="auto" class="lazyautosizes ls-is-cached lazyloaded"
                    src="https://pos.nvncdn.com/cba2a3-7534/ps/20231214_XgJjLAqGgu.jpeg"
                    data-src="https://pos.nvncdn.com/cba2a3-7534/ps/20231214_XgJjLAqGgu.jpeg"
                    alt="Mũ len Red and white big knitting cục bông Xmas - Đỏ" sizes="105px">
                </a>
              </div>
            </td>
            <td class="text-center">
              <a href="/mu-len-red-and-white-big-knitting-cuc-bong-xmas-do-p37901040.html"
                title="Mũ len Red and white big knitting cục bông Xmas - Đỏ">
                {{this.id_product.name}} </a>
              <div class="d-block d-md-none">
                <p>
                  <strong class="d-block product-price">{{this.id_product.price}}</strong>
                </p>
                <p>
                </p>
                <div class="blk-qty d-flex justify-content-center align-items-center">
                  <div data-label="cart" class="blk-qty-btn minus d-flex justify-content-center align-items-center">-
                  </div>
                  <input class="updateCart blk-qty-input d-flex justify-content-center align-items-center product-quantity" type="text"
                    data-psid="37901040" max="22" min="1" value="1" style="margin-bottom: 0;">
                  <div data-label="cart" class="blk-qty-btn plus d-flex justify-content-center align-items-center">+
                  </div>
                </div>
                <p></p>
                <p>
                  <strong class="products-price">{{calculateTotalPrice this.id_product.price this.quantity}}</strong>
                </p>
                <a class="remove-cart" href="javascript:void(0)" data-psid="37901040">Xóa</a>
              </div>
            </td>
            <td class="text-center d-none d-md-table-cell">
              <strong class="d-block product-price">{{this.id_product.price}}</strong>
            </td>
            <td class="text-center d-none d-md-table-cell">
              <div class="blk-qty d-flex justify-content-center align-items-center">
                <div data-label="cart" class="blk-qty-btn minus d-flex justify-content-center align-items-center">-
                </div>
                <input class="updateCart blk-qty-input d-flex justify-content-center align-items-center product-quantity" type="text"
                  data-psid="37901040" max="22" min="1" value="{{this.quantity}}">
                <div data-label="cart" class="blk-qty-btn plus d-flex justify-content-center align-items-center">+</div>
              </div>
            </td>
            <td class="text-center d-none d-md-table-cell">
              <strong class="products-price">{{calculateTotalPrice this.id_product.price this.quantity}}</strong>
            </td>
            <td class="text-center d-none d-md-table-cell">
              <a class="remove-cart" href="javascript:void(0)" data-psid="37901040" data-id="{{this.id_product._id}}">Xóa</a>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
      <div class="note">
        <p>Hỗ trợ ship 20k cho đơn hàng từ 300k khu vực nội thành HN, HCM</p>
        <p>Hỗ trợ ship 30k cho đơn hàng từ 500k các khu vực khác</p>
        <p>Lưu ý:</p>
        <p>Đơn hàng trên website được xử lý trong giờ hành chính</p>
      </div>
      <div class="cart-total text-end">
        <div class="total d-block">Tổng: 1.245.000<sub>đ</sub></div>
        <div class="clearfix"></div>

        <a class="btn btn-lg btn-pink btn-radius" href="/product" style="height: 4.5rem; width: 18rem; font-size: 2rem; text-align:center">Tiếp tục mua sắm</a>
        <a class="btn btn-lg btn-outline-pink btn-radius" href="/cart/checkout" style="height: 4.5rem; width: 13.5rem; font-size: 2rem; text-align:center">Thanh toán</a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
  calculateTotal();
  const removeCartButtons = document.querySelectorAll('.remove-cart');
  const quantityIncreaseButtons = document.querySelectorAll('.blk-qty-btn.plus');
  const quantityDecreaseButtons = document.querySelectorAll('.blk-qty-btn.minus');

   quantityIncreaseButtons.forEach(button => {
    button.addEventListener('click', function() {
      const input = this.closest('.blk-qty').querySelector('.product-quantity');
      input.value = parseInt(input.value, 10) + 1;
      calculateTotal();
    });
  });

  quantityDecreaseButtons.forEach(button => {
    button.addEventListener('click', function() {
      const input = this.closest('.blk-qty').querySelector('.product-quantity');
      if (parseInt(input.value, 10) > 1) {
        input.value = parseInt(input.value, 10) - 1;
        calculateTotal();
      }
    });
  });

  removeCartButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const productId = this.getAttribute('data-id');
      deleteProductFromCart(productId, this);
    });
  });
});

async function deleteProductFromCart(productId, buttonElement) {
  try {
    const response = await fetch(`/product/cart/${productId}`, { method: 'DELETE' });

    if (response.ok) {
      const data = await response.json();
      // Xử lý dữ liệu JSON trả về từ server
      buttonElement.closest('.cart-item').remove();
      calculateTotal();
      // Cập nhật thông tin giỏ hàng nếu cần
    } else {
      // Kiểm tra nếu phản hồi không phải là JSON
      if (response.headers.get("content-type").includes("application/json")) {
        const errorData = await response.json();
        console.error('Error when deleting product from cart', errorData.message);
        alert('Lỗi khi xóa sản phẩm khỏi giỏ hàng: ' + errorData.message);
      } else {
        console.error('Unexpected response from server');
        alert('Lỗi không mong đợi từ server.');
      }
    }
  } catch (error) {
    console.error('There was an error deleting the product from the cart', error);
    alert('Có lỗi xảy ra khi xóa sản phẩm: ' + error.message);
  }
}


function calculateTotal() {
  let total = 0;

  const cartItems = document.querySelectorAll('.cart-item');
  
  cartItems.forEach(item => {
    const priceText = item.querySelector('.products-price').innerText.replace(/[^0-9.,]/g, '').replace(',', '.');
    const quantityText = item.querySelector('.product-quantity').value; // hoặc innerText, tuỳ thuộc vào cấu trúc

    const price = parseFloat(priceText) || 0;
    const quantity = parseInt(quantityText, 10) || 0;
    console.log(quantity);

    total += price;
    console.log(total);
  });

  document.querySelector('.total').innerHTML = `Tổng: ${formatPrice(total)}<sub>đ</sub>`;
}


// Hàm formatPrice để định dạng số theo dạng tiền tệ
function formatPrice(price) {
  return price.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}


</script>